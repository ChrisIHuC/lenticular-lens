version: '3.7'

services:
  postgres:
    build: postgres_timbuctoo
    image: knawhuc/postgres_reconciliation_worker:postgres-latest
    ports:
      - 5432:5432
    volumes:
      - /mnt/SSD/pgdata:/pgdata
    env_file:
      - .docker-env

  jobs_worker:
    build:
      context: .
      dockerfile: Dockerfile.jobs_worker
    image: knawhuc/postgres_reconciliation_worker:jobs_worker-latest
    depends_on:
      - postgres
    environment:
      - DATABASE_CONFIG={"host":"postgres","database":"postgres","user":"postgres","password":"postgres"}
    volumes:
      - output:/common/src/LLData

  timbuctoo_worker:
    build:
      context: .
      dockerfile: Dockerfile.timbuctoo_worker
    image: knawhuc/postgres_reconciliation_worker:timbuctoo_worker-latest
    depends_on:
      - postgres
    environment:
      - DATABASE_CONFIG={"host":"postgres","database":"postgres","user":"postgres","password":"postgres"}

  web_server:
    build:
      context: .
      dockerfile: Dockerfile.web_server
    image: knawhuc/postgres_reconciliation_worker:web_server-latest
    depends_on:
      - postgres
    environment:
      - DATABASE_CONFIG={"host":"postgres","database":"postgres","user":"postgres","password":"postgres"}
    ports:
      - 8000:8000
    volumes:
      - output:/common/src/LLData

  status_monitor:
    build:
      context: .
      dockerfile: Dockerfile.status_monitor
    image: knawhuc/postgres_reconciliation_worker:status_monitor-latest
    depends_on:
      - postgres
      - web_server
      - timbuctoo_worker
      - jobs_worker
    environment:
      - DATABASE_CONFIG={"host":"postgres","database":"postgres","user":"postgres","password":"postgres"}
    volumes:
      - output:/output

volumes:
  pgdata:
  common:
  output: